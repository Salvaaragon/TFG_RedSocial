{% extends 'base.html.twig' %}

{% block body %}
<div class="div_tournaments">
    <div class="jumbotron">
        <div class="container">
            <h1 class="display-4">{{game.name}}</h1>
            <h2><i class="fab fa-{{ game.platform|lower}}"></i> {{game.platform}}</h2>
        </div>
    </div>
    <div class="col-lg-8 offset-lg-2">
    <div class="card">
        <div class="card-header">
            Nuevo torneo de {{game.name}}
        </div>
        <div class="card-body">
            <h2>Detalles</h2>
                <div class="form-group row">
                    <label for="game_name" class="col-sm-2 col-form-label">Juego</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="game_name" value="{{game.name}}" readonly>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="tournament_type" class="col-sm-2 col-form-label">Tipo de torneo</label>
                    <div class="col-sm-10">
                    <select class="form-control" id="tournament_type">
                        <option value="liga">Liga</option>
                        <option value="eliminatoria">Eliminatorias</option>
                    </select>
                    </div>
                </div>
                <div class="form-group row" id="div_league_min_part">
                    <label for="tournament_league_min_part" class="col-sm-2 col-form-label">Participantes mínimos</label>
                    <div class="col-sm-10">
                    <select class="form-control" id="tournament_league_min_part">
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                    </select>
                    </div>
                </div>
                <div class="form-group row" id="div_league_max_part">
                    <label for="tournament_league_max_part" class="col-sm-2 col-form-label">Participantes máximo</label>
                    <div class="col-sm-10">
                    <select class="form-control" id="tournament_league_max_part">
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                    </select>
                    </div>
                </div>
                <div class="form-group row" id="div_match_type" style="display:none;">
                    <label for="tournament_match_type" class="col-sm-2 col-form-label">Tipo de juego</label>
                    <div class="col-sm-10">
                    <select class="form-control" id="tournament_match_type">
                        <option value="1">1v1</option>
                        <option value="2">2v2</option>
                        <option value="3">3v3</option>
                        <option value="4">4v4</option>
                        <option value="5">5v5</option>
                    </select>
                    </div>
                </div>
                <div class="form-group row" id="div_match_part" style="display:none; disbled:true">
                    <label for="tournament_match_part" class="col-sm-2 col-form-label">Participantes requeridos</label>
                    <div class="col-sm-10">
                    <select class="form-control" id="tournament_match_part">
                        <option value="1">2</option>
                        <option value="2">4</option>
                        <option value="3">6</option>
                        <option value="4">8</option>
                        <option value="5">10</option>
                        <option value="6">12</option>
                        <option value="7">14</option>
                        <option value="8">16</option>
                        <option value="9">18</option>
                        <option value="10">20</option>
                    </select>
                    </div>
                </div>
                <div class="form-group row" id="div_league_date_start">
                    <label for="league_date_start" class="col-sm-2 col-form-label">Fecha de inicio</label>
                    <div class="col-sm-10">
                        <div id="league_date_start" class="input-append date league_date_start">
                            <input id="input_league_start" class="form-control" size="16" type="text" value="" readonly required/>
                            <span class="add-on"><i class="icon-th"></i></span>
                        </div>
                    </div>
                </div>
                <div>
                    <h2>Reglas</h2>
                    <div class="form-group row field_wrapper">
                        <div class="col-sm-12 row" id="rule">
                            <div class="col-sm-11 col-10"><input type="text" class="form-control rule" name="field_name[]" value="" required/></div>
                            <div class="col-sm-1 col-1"><a href="javascript:void(0);" class="add_button btn btn-primary" title="Add field"><i class="fas fa-plus"></i></a></div>
                        </div>
                    </div>
                </div>

                <button type="button" id="create_new_tournament" class="btn btn-primary">Crear torneo</button>
                <a href="{{ path('game', {'game_name':game.name}) }}" class="btn btn-danger">Cancelar</a>
        </div>
    </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}

<script type="text/javascript"> 

$(document).ready(function(){  

    $('#tournament_type').val('liga');
    $('#tournament_match_type').val(1);
    $('#tournament_match_part').val(1);
    
    $('#tournament_type').on('change', function() {
        var tournament_type = $('#tournament_type').val();
        var div_match_type = document.getElementById('div_match_type');
        var div_match_part = document.getElementById('div_match_part');
        var div_league_min_part = document.getElementById('div_league_min_part');
        var div_league_max_part = document.getElementById('div_league_max_part');

        if(tournament_type == 'liga') {
            div_match_type.style.display = "none";
            div_match_type.disabled = true;
            div_match_part.style.display = "none";
            div_match_part.disabled = true;
            div_league_min_part.style.display = "flex";
            div_league_min_part.disabled = false;
            div_league_max_part.style.display = "flex";
            div_league_max_part.disabled = false;
            $('#tournament_match_type').val(1);
            $('#tournament_match_part').val(1);
            div_league_min_part.val(5);
            div_league_max_part.val(15);
        }
        if(tournament_type == 'eliminatoria') {
            div_match_type.style.display = "flex";
            div_match_type.disabled = false;
            div_match_part.style.display = "flex";
            div_match_part.disabled = false;
            div_league_min_part.style.display = "none";
            div_league_min_part.disabled = true;
            div_league_max_part.style.display = "none";
            div_league_max_part.disabled = true;
            $('#tournament_match_type').val(1);
            div_league_min_part.val(5);
            div_league_max_part.val(15);
        }
    }); 

    $('#tournament_match_type').on('change', function() {
        var tournament_match_type = $('#tournament_match_type').val();//1,2,3,4 o 5
        var tournament_match_part = document.getElementById('tournament_match_part');
        var div_match_part = document.getElementById('div_match_part');

        tournament_match_part.options.length = 0;

        var last_value = tournament_match_type * 2;
        var max_length = 10;

        if(tournament_match_type > 2)
            max_length = 5;
        
        for(var index = 0; index < max_length; index++) {
            var option = document.createElement('option');
            option.value = last_value;
            option.innerHTML = last_value;
            last_value = parseInt(last_value) + parseInt(tournament_match_type);
            tournament_match_part.appendChild(option);
        }
    });

    var date = new Date();
    var minDate_start = new Date(date.getFullYear(), date.getMonth(), date.getDate()+14);
    var maxDate_start = new Date(date.getFullYear(), date.getMonth()+1, date.getDate()+14);

    $(".league_date_start").datetimepicker({
        format: "dd MM yyyy - hh:ii",
        weekStart: "1",
        startDate: minDate_start,
        endDate: maxDate_start,
        autoclose: "true",
        pickerPosition: "top-right",
        setDate: minDate_start
    });

    $(".league_date_start").datetimepicker('setDate', minDate_start);

    var addButton = $('.add_button'); //Add button selector
    var wrapper = $('.field_wrapper'); //Input field wrapper
    var fieldHTML = '<div class="col-sm-12 row new_rule_tournament rule" id="rule"><div class="col-sm-11 col-10"><input type="text" class="form-control" name="field_name[]" value="" required/></div><div class="col-sm-1 col-1"><a href="javascript:void(0);" class="btn btn-danger remove_button" title="Remove field"><i class="fas fa-minus"></i></a></div></div>';

    var x = 1; //Initial field counter is 1
    $(addButton).click(function(){ //Once add button is clicked
        if(x <10){ //Check maximum number of input fields
            x++; //Increment field counter
            $(wrapper).append(fieldHTML); // Add field html
        }
    });
    $(wrapper).on('click', '.remove_button', function(e){ //Once remove button is clicked
        e.preventDefault();
        $(this).parent('div').parent('div').remove(); //Remove field html
        x--; //Decrement field counter
    });

    $("#create_new_tournament").click(function() {
        var empty_rules = false;
        var indexRules = 0;
        var rules = {};
        $('input[name="field_name[]"]').each(function() { 
            rules['rule_'.concat(indexRules)] = $(this).val(); 
            if(rules['rule_'.concat(indexRules)] == "") empty_rules = true;
            indexRules++; 
        });

        if(!empty_rules) {
            var data = {}
            var game_name;
            var tournament_type;
            var tournament_start;
            var tournament_start_formatted;

            game_name = $('#game_name').val();
            tournament_type = $('#tournament_type').val();
            tournament_start = $("#league_date_start").data('datetimepicker').getDate();
            tournament_start_formatted = tournament_start.getFullYear() + "-" + (tournament_start.getMonth() + 1) + "-" + tournament_start.getDate() + " " + tournament_start.getHours() + ":" + tournament_start.getMinutes() + ":" + tournament_start.getSeconds();

            if(tournament_type == 'liga') {
                var league_min_part;
                var league_max_part;
                league_min_part = $('#tournament_league_min_part').val();
                league_max_part = $('#tournament_league_max_part').val();
                data['min_part'] = league_min_part;
                data['max_part'] = league_max_part;
            }
            else {
                var match_type;
                var match_part;
                match_type = $('#tournament_match_type').val();
                match_part = $('#tournament_match_part').val();
                data['match_type'] = match_type;
                data['match_part'] = match_part;
            }

            data['game_name'] = game_name;
            data['tournament_type'] = tournament_type;
            data['tournament_date'] = tournament_start_formatted;
            data['num_rules'] = indexRules;
            
            $.ajax({
                url: Routing.generate('create_tournament'),
                type: "POST",
                data: { 'data':data, 'rules':rules},
                success: function (data) {
                    console.log("Torneo creado correctamente");
                    window.location.replace(window.location.origin.concat("/app_dev.php/tournaments_game/").concat(game_name));
                },
                error : function(xhr, status, errorMessage) {
                    alert("Algo ha salido mal: "+errorMessage);
                }
            });
        }
        else
            alert("Los campos de reglas son obligatorios");
    });

});

</script>

{% endblock %}